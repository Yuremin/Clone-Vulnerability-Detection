import sys
sys.path.append("/home/min/Projects/Guotie/CVD/src/antlr")
from antlr4 import *
from JavaLexer import JavaLexer
from JavaParser import JavaParser
from JavaParserListener import JavaParserListener


class FunctionPrinter(JavaParserListener):
    def __init__(self):
        self.function_list = []
    def getAllText(self, ctx):
        token_stream = ctx.parser.getTokenStream()
        lexer = token_stream.tokenSource
        input_stream = lexer.inputStream
        start = ctx.start.start
        stop = ctx.stop.stop
        return input_stream.getText(start, stop)

    def enterMethodDeclaration(self, ctx):
        variables = []
        for i in ctx.methodBody().block().blockStatement():
            if i.localVariableDeclaration():
                if i.localVariableDeclaration().identifier():
                    variables.append(i.localVariableDeclaration().identifier().getText())
                elif i.localVariableDeclaration().variableDeclarators():
                    for j in i.localVariableDeclaration().variableDeclarators().variableDeclarator():
                        variables.append(j.variableDeclaratorId().getText())

        self.function_list.append({
            "funcbody":self.getAllText(ctx.methodBody()),
            "name":ctx.identifier().getText(),
            "parameters":ctx.formalParameters().getText(),
            "variables":variables
            })
        
def javaparser(path):
    input_stream = FileStream(path)
    lexer = JavaLexer(input_stream)
    stream = CommonTokenStream(lexer)
    parser = JavaParser(stream)
    tree = parser.compilationUnit()

    printer = FunctionPrinter()

    walker = ParseTreeWalker()
    walker.walk(printer, tree)

    return printer.function_list


 
if __name__ == '__main__':
    main(sys.argv)
