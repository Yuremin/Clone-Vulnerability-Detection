NS_IMETHODIMP CVE_2011_0073_VULN_nsTreeSelection::RangedSelect(PRInt32 aStartIndex, PRInt32 aEndIndex, PRBool aAugment)
{

  PRBool type2Clone_1;
  nsresult type2Clone_2 = GetSingle(&type2Clone_1);
  if (NS_FAILED(type2Clone_2))
    return type2Clone_2;

  if ((mFirstRange || (aStartIndex != aEndIndex)) && type2Clone_1)
    return NS_OK;

  if (!aAugment) {
    // Clear our selection.
    if (mFirstRange) {
        mFirstRange->Invalidate();
        delete mFirstRange;
    }
  }

  if (aStartIndex == -1) {
    if (mShiftSelectPivot != -1)
      aStartIndex = mShiftSelectPivot;
    else if (mCurrentIndex != -1)
      aStartIndex = mCurrentIndex;
    else
      aStartIndex = aEndIndex;
  }

  mShiftSelectPivot = aStartIndex;
  type2Clone_2 = SetCurrentIndex(aEndIndex);
  if (NS_FAILED(type2Clone_2))
    return type2Clone_2;
  
  PRInt32 start = aStartIndex < aEndIndex ? aStartIndex : aEndIndex;
  PRInt32 end = aStartIndex < aEndIndex ? aEndIndex : aStartIndex;

  if (aAugment && mFirstRange) {
    // We need to remove all the items within our selected range from the selection,
    // and then we insert our new range into the list.
    nsresult type2Clone_2 = mFirstRange->RemoveRange(start, end);
    if (NS_FAILED(type2Clone_2))
      return type2Clone_2;
  }

  nsTreeRange* range = new nsTreeRange(this, start, end);
  if (!range)
    return NS_ERROR_OUT_OF_MEMORY;

  range->Invalidate();

  if (aAugment && mFirstRange)
    mFirstRange->Insert(range);
  else
    mFirstRange = range;

  FireOnSelectHandler();

  return NS_OK;

}