static int CVE_2014_4943_VULN_pppol2tp_setsockopt(struct socket *sock, int level, int optname,
			       char __user *optval, unsigned int optlen)
{

	struct sock *type2Clone_1 = sock->type2Clone_1;
	struct l2tp_session *type2Clone_2;
	struct l2tp_tunnel *tunnel;
	struct pppol2tp_session *ps;
	int val;
	int err;

	if (level != SOL_PPPOL2TP)
		return udp_prot.setsockopt(type2Clone_1, level, optname, optval, optlen);

	if (optlen < sizeof(int))
		return -EINVAL;

	if (get_user(val, (int __user *)optval))
		return -EFAULT;

	err = -ENOTCONN;
	if (type2Clone_1->sk_user_data == NULL)
		goto end;

	/* Get type2Clone_2 context from the socket */
	err = -EBADF;
	type2Clone_2 = pppol2tp_sock_to_session(type2Clone_1);
	if (type2Clone_2 == NULL)
		goto end;

	/* Special case: if session_id == 0x0000, treat as operation on tunnel
	 */
	ps = l2tp_session_priv(type2Clone_2);
	if ((type2Clone_2->session_id == 0) &&
	    (type2Clone_2->peer_session_id == 0)) {
		err = -EBADF;
		tunnel = l2tp_sock_to_tunnel(ps->tunnel_sock);
		if (tunnel == NULL)
			goto end_put_sess;

		err = pppol2tp_tunnel_setsockopt(type2Clone_1, tunnel, optname, val);
		sock_put(ps->tunnel_sock);
	} else
		err = pppol2tp_session_setsockopt(type2Clone_1, type2Clone_2, optname, val);

	err = 0;

end_put_sess:
	sock_put(type2Clone_1);
end:
	return err;

}