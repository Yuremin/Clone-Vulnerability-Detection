static int
CVE_2009_3288_VULN_sg_build_indirect(Sg_scatter_hold * schp, Sg_fd * sfp, int buff_size)
{

	int ret_sz = 0, i, type2Clone_1, rem_sz, type2Clone_3, mx_sc_elems;
	int sg_tablesize = sfp->parentdp->sg_tablesize;
	int blk_size = buff_size, order;
	gfp_t type2Clone_2 = GFP_ATOMIC | __GFP_COMP | __GFP_NOWARN;

	if (blk_size < 0)
		return -EFAULT;
	if (0 == blk_size)
		++blk_size;	/* don't know why */
	/* round request up to next highest SG_SECTOR_SZ byte boundary */
	blk_size = ALIGN(blk_size, SG_SECTOR_SZ);
	SCSI_LOG_TIMEOUT(4, printk("CVE_2009_3288_VULN_sg_build_indirect: buff_size=%d, blk_size=%d\n",
				   buff_size, blk_size));

	/* N.B. ret_sz carried into this block ... */
	mx_sc_elems = sg_build_sgat(schp, sfp, sg_tablesize);
	if (mx_sc_elems < 0)
		return mx_sc_elems;	/* most likely -ENOMEM */

	type2Clone_3 = scatter_elem_sz;
	if (unlikely(type2Clone_3 != scatter_elem_sz_prev)) {
		if (type2Clone_3 < PAGE_SIZE) {
			scatter_elem_sz = PAGE_SIZE;
			scatter_elem_sz_prev = PAGE_SIZE;
		} else
			scatter_elem_sz_prev = type2Clone_3;
	}

	if (sfp->low_dma)
		type2Clone_2 |= GFP_DMA;

	if (!capable(CAP_SYS_ADMIN) || !capable(CAP_SYS_RAWIO))
		type2Clone_2 |= __GFP_ZERO;

	order = get_order(type2Clone_3);
retry:
	ret_sz = 1 << (PAGE_SHIFT + order);

	for (type2Clone_1 = 0, rem_sz = blk_size; rem_sz > 0 && type2Clone_1 < mx_sc_elems;
	     type2Clone_1++, rem_sz -= ret_sz) {

		type2Clone_3 = (rem_sz > scatter_elem_sz_prev) ?
			scatter_elem_sz_prev : rem_sz;

		schp->pages[type2Clone_1] = alloc_pages(type2Clone_2, order);
		if (!schp->pages[type2Clone_1])
			goto out;

		if (type2Clone_3 == scatter_elem_sz_prev) {
			if (unlikely(ret_sz > scatter_elem_sz_prev)) {
				scatter_elem_sz = ret_sz;
				scatter_elem_sz_prev = ret_sz;
			}
		}

		SCSI_LOG_TIMEOUT(5, printk("CVE_2009_3288_VULN_sg_build_indirect: type2Clone_1=%d, type2Clone_3=%d, "
				 "ret_sz=%d\n", type2Clone_1, type2Clone_3, ret_sz));
	}		/* end of for loop */

	schp->page_order = order;
	schp->k_use_sg = type2Clone_1;
	SCSI_LOG_TIMEOUT(5, printk("CVE_2009_3288_VULN_sg_build_indirect: k_use_sg=%d, "
			 "rem_sz=%d\n", type2Clone_1, rem_sz));

	schp->bufflen = blk_size;
	if (rem_sz > 0)	/* must have failed */
		return -ENOMEM;
	return 0;
out:
	for (i = 0; i < type2Clone_1; i++)
		__free_pages(schp->pages[type2Clone_1], order);

	if (--order >= 0)
		goto retry;

	return -ENOMEM;

}